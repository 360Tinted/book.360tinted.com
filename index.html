<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento 360 Tinted</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos Globais */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: #fff;
            margin: 20px auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 95%;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        /* Seções do Formulário */
        .form-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .form-section h2 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .form-section h2 svg {
            margin-right: 10px;
            color: #3498db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input[type="date"], input[type="text"], input[type="email"], input[type="tel"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input[type="date"]:focus, input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Estilos para Horários Disponíveis */
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 5px; /* Ajustado para caber em telas menores */
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s, transform 0.2s;
            white-space: nowrap; /* Evita quebra de linha no texto do botão */
            overflow: hidden; /* Garante que o texto não "transborde" */
            text-overflow: ellipsis; /* Adiciona reticências se o texto for muito longo */
        }

        .time-slot-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .time-slot-button.selected {
            background-color: #27ae60;
            border: 2px solid #2ecc71;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
        }

        /* Resumo do Agendamento */
        .appointment-summary {
            background-color: #e8f5e9;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            margin-top: 20px;
        }

        .appointment-summary h3 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .appointment-summary p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .appointment-summary strong {
            color: #333;
        }

        /* Botão de Confirmação */
        .confirm-button {
            width: 100%;
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            margin-top: 20px;
        }

        .confirm-button:hover:not(:disabled) {
            background-color: #218838;
        }

        .confirm-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Mensagens de Erro/Sucesso */
        .error-message, .success-message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .hidden {
            display: none;
        }

        /* Spinner de Carregamento */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Escondido por padrão */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px auto;
            }

            .time-slots-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Ajusta para telas menores */
            }

            .time-slot-button {
                font-size: 14px;
                padding: 8px 3px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 24px;
            }

            .form-section h2 {
                font-size: 20px;
            }

            .time-slots-grid {
                grid-template-columns: 1fr 1fr; /* Duas colunas em telas muito pequenas */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Schedule your appointment quickly and easily</h1>

        <div id="errorMessage" class="error-message hidden"></div>
        <div id="successMessage" class="success-message hidden"></div>

        <div class="form-section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>
                Select Service and Time
            </h2>
            <div class="form-group">
                <label for="serviceSelect">Service Type:</label>
                <select id="serviceSelect">
                    <option value="">Select a service</option>
                    </select>
            </div>
            <div class="form-group">
                <label for="dateInput">Date:</label>
                <input type="date" id="dateInput">
            </div>

            <div id="loadingSpinner" class="spinner hidden"></div>

            <div id="availableTimeSlotsSection" class="form-group hidden">
                <label>Available Time Slots:</label>
                <div id="availableTimeSlots" class="time-slots-grid">
                    </div>
            </div>
        </div>

        <div class="form-section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Your Information
            </h2>
            <div class="form-group">
                <label for="fullNameInput">Full Name:</label>
                <input type="text" id="fullNameInput" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label for="emailInput">E-mail:</label>
                <input type="email" id="emailInput" placeholder="Enter your e-mail">
            </div>
            <div class="form-group">
                <label for="phoneInput">Phone:</label>
                <input type="tel" id="phoneInput" placeholder="Enter your phone number">
            </div>
        </div>

        <div class="appointment-summary hidden" id="appointmentSummary">
            <h3>Appointment Summary</h3>
            <p><strong>Service:</strong> <span id="summaryService">N/A</span></p>
            <p><strong>Date:</strong> <span id="summaryDate">N/A</span></p>
            <p><strong>Time:</strong> <span id="summaryTime">N/A</span></p>
            <p><strong>Price:</strong> <span id="summaryPrice">N/A</span></p>
            <p><strong>Your Name:</strong> <span id="summaryName">N/A</span></p>
            <p><strong>Your E-mail:</strong> <span id="summaryEmail">N/A</span></p>
            <p><strong>Your Phone:</strong> <span id="summaryPhone">N/A</span></p>
        </div>

        <button id="confirmButton" class="confirm-button" disabled>Confirm Appointment</button>
    </div>

    <script>
        // Elementos do DOM
        const serviceSelect = document.getElementById('serviceSelect');
        const dateInput = document.getElementById('dateInput');
        const availableTimeSlotsSection = document.getElementById('availableTimeSlotsSection');
        const availableTimeSlotsDiv = document.getElementById('availableTimeSlots');
        const fullNameInput = document.getElementById('fullNameInput');
        const emailInput = document.getElementById('emailInput');
        const phoneInput = document.getElementById('phoneInput');
        const confirmButton = document.getElementById('confirmButton');
        const appointmentSummary = document.getElementById('appointmentSummary');
        const errorMessageDiv = document.getElementById('errorMessage');
        const successMessageDiv = document.getElementById('successMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Estado do formulário
        const formData = {
            service: null,
            serviceName: null,
            serviceDuration: null,
            servicePrice: null,
            date: null,
            time: null,
            endTime: null, // Adicionado para armazenar o tempo de término do slot
            fullName: null,
            email: null,
            phone: null
        };

        // --- Funções de Utilitário ---

        function showLoadingSpinner() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            loadingSpinner.classList.add('hidden');
        }

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            successMessageDiv.classList.add('hidden'); // Esconde mensagem de sucesso
        }

        function hideError() {
            errorMessageDiv.classList.add('hidden');
        }

        function showSuccess(message) {
            successMessageDiv.textContent = message;
            successMessageDiv.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden'); // Esconde mensagem de erro
        }

        function hideSuccess() {
            successMessageDiv.classList.add('hidden');
        }

        function formatPhoneNumber(number) {
            // Remove tudo que não for dígito
            const cleanNum = number.replace(/\D/g, '');

            // Formata (XX) XXXXX-XXXX
            if (cleanNum.length === 11) {
                return `(${cleanNum.substring(0, 2)}) ${cleanNum.substring(2, 7)}-${cleanNum.substring(7, 11)}`;
            }
            // Formata (XX) XXXX-XXXX (para números mais antigos)
            else if (cleanNum.length === 10) {
                return `(${cleanNum.substring(0, 2)}) ${cleanNum.substring(2, 6)}-${cleanNum.substring(6, 10)}`;
            }
            return number; // Retorna o original se não corresponder
        }

        // --- Carregamento de Dados Iniciais ---

        async function loadServices() {
            try {
                showLoadingSpinner();
                const response = await fetch('/api/services');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const services = await response.json();

                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.service_id; // *** CORRIGIDO: Agora usa service_id (numérico) ***
                    option.textContent = `${service.name} - $${service.price.toFixed(2)}`; // Formata preço
                    option.dataset.duration = service.duration; // Armazena duração para uso futuro
                    option.dataset.price = service.price.toFixed(2); // Armazena preço
                    option.dataset.name = service.name; // Armazena nome
                    serviceSelect.appendChild(option);
                });
                hideLoadingSpinner();
            } catch (error) {
                console.error('Error loading services:', error);
                showError(`Erro ao carregar serviços: ${error.message || error}`);
                hideLoadingSpinner();
            }
        }

        // --- Lógica de Seleção ---

        async function loadAvailableTimes(serviceId, date) {
            try {
                showLoadingSpinner();
                availableTimeSlotsDiv.innerHTML = ''; // Limpa slots anteriores
                availableTimeSlotsSection.classList.add('hidden'); // Esconde a seção enquanto carrega

                const response = await fetch(`/api/available-times?date=${date}&service_id=${serviceId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const times = await response.json();

                if (times.length === 0) {
                    availableTimeSlotsDiv.innerHTML = '<p>Nenhum horário disponível para esta data e serviço.</p>';
                } else {
                    times.forEach(slot => {
                        const button = document.createElement('button');
                        button.className = 'time-slot-button';
                        button.dataset.startTime = slot.start_time; // Armazena o horário de início
                        button.dataset.endTime = slot.end_time; // Armazena o horário de término
                        button.textContent = slot.start_time; // Exibe o horário de início
                        button.addEventListener('click', () => selectTimeSlot(slot.start_time, slot.end_time));
                        availableTimeSlotsDiv.appendChild(button);
                    });
                }
                availableTimeSlotsSection.classList.remove('hidden'); // Mostra a seção
            } catch (error) {
                console.error('Error loading times:', error);
                showError(`Erro ao carregar horários: ${error.message || error}`);
            } finally {
                hideLoadingSpinner();
            }
        }

        function selectTimeSlot(startTime, endTime) {
            // Remove a seleção de todos os botões antes de aplicar ao novo
            document.querySelectorAll('.time-slot-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Adiciona a classe 'selected' ao botão clicado
            const selectedButton = document.querySelector(`[data-start-time="${startTime}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }

            // Armazena o horário selecionado no formData
            formData.time = startTime;
            formData.endTime = endTime; // Armazena o tempo de término também
            updateAppointmentSummary();
        }

        async function handleSelectionChange() {
            hideError(); // Esconde erros anteriores

            const serviceId = serviceSelect.value;
            const selectedDate = dateInput.value;

            // Limpa os slots e esconde a seção se não houver um serviço ou data válida
            availableTimeSlotsDiv.innerHTML = '';
            availableTimeSlotsSection.classList.add('hidden');

            if (!serviceId) {
                showError('Por favor, selecione um tipo de serviço primeiro.');
                formData.service = null; // Limpa o serviço se não houver seleção
                formData.date = null;
                formData.time = null;
                formData.endTime = null;
                updateAppointmentSummary();
                return;
            }

            // Pega os detalhes do serviço do option selecionado
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            formData.service = serviceId; // O ID numérico
            formData.serviceName = selectedOption.dataset.name;
            formData.serviceDuration = parseInt(selectedOption.dataset.duration);
            formData.servicePrice = parseFloat(selectedOption.dataset.price);

            if (!selectedDate) {
                showError('Por favor, selecione uma data.');
                formData.date = null; // Limpa a data se não houver seleção
                formData.time = null;
                formData.endTime = null;
                updateAppointmentSummary();
                return;
            }
            formData.date = selectedDate;

            // Se ambos estão definidos, carregue os horários
            await loadAvailableTimes(serviceId, selectedDate);
            updateAppointmentSummary(); // Atualiza o resumo após carregar horários ou erro
        }

        // --- Atualização do Resumo e Habilitação do Botão ---

        function updateAppointmentSummary() {
            // Atualiza os dados do cliente
            formData.fullName = fullNameInput.value.trim();
            formData.email = emailInput.value.trim();
            formData.phone = formatPhoneNumber(phoneInput.value.trim());

            // Atualiza a exibição no resumo
            document.getElementById('summaryService').textContent = formData.serviceName || 'N/A';
            document.getElementById('summaryDate').textContent = formData.date ? new Date(formData.date + 'T12:00:00').toLocaleDateString('pt-BR') : 'N/A'; // Adiciona T12:00:00 para evitar problemas de fuso horário com toLocaleDateString
            document.getElementById('summaryTime').textContent = formData.time || 'N/A';
            document.getElementById('summaryPrice').textContent = formData.servicePrice ? `$${formData.servicePrice.toFixed(2)}` : 'N/A';
            document.getElementById('summaryName').textContent = formData.fullName || 'N/A';
            document.getElementById('summaryEmail').textContent = formData.email || 'N/A';
            document.getElementById('summaryPhone').textContent = formData.phone || 'N/A';

            // Mostra/Esconde o resumo
            const isSummaryComplete = formData.service && formData.date && formData.time && formData.fullName && formData.email && formData.phone;
            if (isSummaryComplete) {
                appointmentSummary.classList.remove('hidden');
                confirmButton.disabled = false;
            } else {
                appointmentSummary.classList.add('hidden');
                confirmButton.disabled = true;
            }
        }

        // --- Lógica de Confirmação de Agendamento ---

        async function confirmAppointment() {
            hideError();
            hideSuccess();
            confirmButton.disabled = true; // Desabilita o botão para evitar cliques múltiplos

            // Validação final antes de enviar
            if (!formData.service || !formData.date || !formData.time || !formData.fullName || !formData.email || !formData.phone) {
                showError('Por favor, preencha todos os campos do agendamento.');
                confirmButton.disabled = false;
                return;
            }

            const appointmentData = {
                service_id: formData.service,
                date: formData.date,
                start_time: formData.time,
                end_time: formData.endTime, // Inclui o tempo de término
                client_name: formData.fullName,
                client_email: formData.email,
                client_phone: formData.phone
            };

            try {
                showLoadingSpinner();
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showSuccess('Agendamento confirmado com sucesso! Verifique seu e-mail.');
                console.log('Appointment Confirmed:', result);

                // Opcional: Redirecionar ou limpar o formulário após sucesso
                setTimeout(() => {
                    // window.location.reload(); // Recarrega a página
                    // Ou limpar campos para novo agendamento
                    serviceSelect.value = '';
                    dateInput.value = '';
                    availableTimeSlotsDiv.innerHTML = '';
                    availableTimeSlotsSection.classList.add('hidden');
                    fullNameInput.value = '';
                    emailInput.value = '';
                    phoneInput.value = '';
                    formData.service = null;
                    formData.date = null;
                    formData.time = null;
                    formData.endTime = null;
                    formData.fullName = null;
                    formData.email = null;
                    formData.phone = null;
                    updateAppointmentSummary(); // Limpa o resumo
                    hideSuccess();
                    confirmButton.disabled = false;
                }, 3000); // Exibe mensagem por 3 segundos antes de limpar
            } catch (error) {
                console.error('Error confirming appointment:', error);
                showError(`Erro ao confirmar agendamento: ${error.message || error}`);
                confirmButton.disabled = false;
            } finally {
                hideLoadingSpinner();
            }
        }

        // --- Event Listeners ---

        // Carrega serviços quando a página é carregada
        document.addEventListener('DOMContentLoaded', () => {
            // Define a data mínima como hoje
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.min = `${year}-${month}-${day}`;

            loadServices();
            updateAppointmentSummary(); // Inicializa o resumo e o estado do botão
        });

        // Adiciona event listeners para mudanças que afetam o agendamento ou resumo
        serviceSelect.addEventListener('change', handleSelectionChange);
        dateInput.addEventListener('change', handleSelectionChange);
        fullNameInput.addEventListener('input', updateAppointmentSummary);
        emailInput.addEventListener('input', updateAppointmentSummary);
        phoneInput.addEventListener('input', updateAppointmentSummary);
        confirmButton.addEventListener('click', confirmAppointment);

    </script>
</body>
</html>
